# Отчёт: что сделано и что осталось (Era Shop)

## Откуда копировалось

- **Flutter-приложение:** чистая копия из архива `era-shop-v2` (мобильное приложение Era Shop) → папка `era_shop_clean` (репозиторий **gogoera**).
- **Бэкенд:** скопирован из `C:\Users\buran\gogoerashop\admin\admin\backend` → в `era_shop_clean\backend`.

---

## Что сделано

### 1. Структура репозитория (один репо — приложение + бэкенд)

- В одном репозитории **gogoera** (GitHub: `buranovt2025-jpg/gogoera`) лежат:
  - Flutter-приложение (корень репо),
  - папка **backend/** — Node.js API (все модули: user, product, cart, order, reel, seller, category, setting и т.д.).

### 2. Настройка Flutter-приложения

- **`lib/utiles/api_url.dart`:**
  - `BASE_URL = "http://146.190.238.186:5000/"`
  - `SECRET_KEY = "5TIvw5cpc0"`
- **`lib/main.dart`:**
  - Инициализация Firebase в `try/catch` — приложение не падает на вебе без конфига Firebase.
  - Crashlytics и FCM включаются только если Firebase инициализирован.
  - Для веба добавлен fallback для `PlatformDeviceId.getDeviceId` (например `web-{timestamp}`).
- Исправления под сборку на сервере (Dart 3.6, зависимости):
  - В **pubspec.yaml** — `dependency_overrides` для `image_picker` / `image_picker_platform_interface` (совместимость с Dart 3.6).
  - Обновлён **flutterwave_standard** и вызовы в `lib/PaymentMethod/flutter_wave/flutter_wave_pay.dart`.
  - Исправлены типы **cool_dropdown** (`DropdownController<String>`) в: `seller_add_product.dart`, `seller_edit_product.dart`, `add_to_cart_bottom_sheet.dart`, `product_detail.dart`.
- Удалены захардкоженные ключи из `lib/utiles/globle_veriables.dart` (чтобы не блокировал push в GitHub).

### 3. Копирование и настройка бэкенда

- Скопирована вся папка **backend** из `gogoerashop\admin\admin\backend` в `era_shop_clean\backend`:
  - **server/** — все модули (address, admin, attributes, bank, cart, category, dashboard, FAQ, favorite, follower, reel, order, product, seller, setting, user и т.д.).
  - **config.js**, **index.js**, **route.js**, **setting.js**, **socket.js**, **util/**.
- **backend/config.js** настроен под сервер:
  - `baseURL = "http://146.190.238.186:5000/"`
  - `secretKey = "5TIvw5cpc0"`
  - `JWT_SECRET = "2FhKmINItB"`
  - `MONGODB_CONNECTION_STRING = "mongodb://127.0.0.1:27017/erashop"`
- **backend/setting.js** — чувствительные ключи заменены на плейсхолдеры (Stripe, Razorpay, Flutterwave, Firebase private key), чтобы не коммитить секреты.
- В репо добавлен **backend/DB/attributes.json** (сиды атрибутов).

### 4. Деплой на сервер (DigitalOcean, Ubuntu)

- **DEPLOY_ALL.sh** — один скрипт, который на сервере:
  1. Клонирует/обновляет репо в `/var/era_shop_web/gogoera`.
  2. Ставит Node.js 18, MongoDB, PM2 (если ещё нет).
  3. В `backend/` выполняет `npm install`, запускает приложение через `pm2 start index.js --name era-backend`.
  4. Собирает Flutter web: `flutter build web --release`.
  5. Настраивает Nginx: root = `/var/era_shop_web/gogoera/build/web`, `try_files` для SPA.
  6. Перезагружает Nginx.
- Документация:
  - **README.md** — обзор проекта и запуск через `DEPLOY_ALL.sh`.
  - **DEPLOY.md** — общий деплой (Flutter + бэкенд, размер дроплета).
  - **BACKEND_DEPLOY.md** — пошаговый ручной деплой бэкенда.
  - **SERVER_QUICK_FIX.txt**, **ВЕБ_НА_СЕРВЕРЕ.txt**, **NGINX_404_FIX.md** и др. — подсказки по серверу и Nginx.

### 5. Итог на сервере

- Сайт: **http://146.190.238.186/** — отдаётся Flutter web (приветственный экран).
- API: **http://146.190.238.186:5000/** — бэкенд под PM2 (например, `/setting` отдаёт JSON).
- Репозиторий и скрипт деплоя содержат всё необходимое для повторного развёртывания.

---

## Что осталось (нужно сделать вручную или позже)

### 1. Данные в MongoDB

- MongoDB после установки пустая. Чтобы в приложении были категории, товары, настройки:
  - **Вариант А:** использовать админ-панель Era Shop (отдельный проект из era-shop-v2: admin frontend + этот же API), создать категории, товары, настройки через неё.
  - **Вариант Б:** импортировать в MongoDB данные из папки **DB** исходного Era Shop (например `settings.json`, коллекции по моделям бэкенда). В репо уже есть только **backend/DB/attributes.json** — его можно импортировать для атрибутов.

### 2. Firebase (пуши, Crashlytics)

- В коде приложение готово работать с Firebase (FCM, Crashlytics), но конфиг на вебе не обязателен — приложение стартует и без него.
- Чтобы включить пуши и Crashlytics:
  - Создать проект в Firebase Console.
  - Добавить веб/Android/iOS приложения, скачать конфиги.
  - Положить `google-services.json` (Android), при необходимости `GoogleService-Info.plist` (iOS), для веба — конфиг в `index.html` / `firebase_options.dart` (если используете FlutterFire).
  - На бэкенде в **setting.js** указать актуальный **privateKey** для FCM (если отправка пушей с сервера).

### 3. Платежи (Stripe, Razorpay, Flutterwave)

- В **backend/setting.js** стоят плейсхолдеры (`YOUR_STRIPE_...`, `YOUR_RAZORPAY_...`, `YOUR_FLUTTERWAVE_...`).
- Для реальных платежей: заменить на свои ключи из кабинетов Stripe/Razorpay/Flutterwave (и при необходимости поправить `lib/utiles/globle_veriables.dart` для публичных ключей на клиенте).

### 4. Домен и HTTPS

- Сейчас доступ по IP: **http://146.190.238.186/** и **http://146.190.238.186:5000/**.
- Для продакшена обычно:
  - Привязывают домен к серверу (A-запись на IP).
  - В **api_url.dart** и **backend/config.js** меняют `BASE_URL` на `https://api.ваш-домен.com/` (или аналог).
  - Ставят Nginx + Let's Encrypt (certbot) для HTTPS на 80/443 и при необходимости проксируют API с 5000 на 443.

### 5. Админ-панель (отдельный проект)

- Админка Era Shop (frontend из era-shop-v2, например в `gogoerashop\admin\admin\frontend`) в этот репозиторий **не копировалась**.
- Она подключается к тому же API (`http://146.190.238.186:5000/`). Если нужна админка на том же сервере — её нужно развернуть отдельно (свой деплой, свой поддомен/порт).

### 6. Проверка работы приложения

- Стоит вручную проверить:
  - **http://146.190.238.186/** — логин, лента, каталог, корзина, профиль (после появления данных в MongoDB).
  - **http://146.190.238.186:5000/setting** — ответ API (JSON).
- Если что-то не грузится — смотреть консоль браузера и логи PM2 (`pm2 logs era-backend`).

---

## Краткая сводка

| Что сделано | Где / как |
|-------------|-----------|
| Flutter-приложение в одном репо | Корень gogoera (GitHub) |
| Бэкенд скопирован и настроен | `era_shop_clean/backend`, config.js под 146.190.238.186:5000 |
| api_url.dart под сервер | BASE_URL, SECRET_KEY |
| main.dart — работа без Firebase на вебе | try/catch Firebase, fallback deviceId |
| Исправления сборки (Dart, пакеты, dropdown) | pubspec.yaml, flutter_wave_pay, 4 файла с cool_dropdown |
| Один скрипт деплоя | DEPLOY_ALL.sh (репо, Node, MongoDB, PM2, backend, Flutter web, Nginx) |
| Документация | README, DEPLOY.md, BACKEND_DEPLOY.md, серверные заметки |

| Что осталось | Действие |
|--------------|----------|
| Данные в MongoDB | Админка или импорт DB (attributes.json уже в репо) |
| Firebase (пуши, Crashlytics) | Создать проект, добавить конфиги и privateKey в setting.js |
| Платежи | Подставить реальные ключи в backend/setting.js |
| Домен + HTTPS | Домен, certbot, обновить BASE_URL |
| Админ-панель | Развернуть отдельно, если нужна |
| Ручная проверка сайта и API | Открыть в браузере, проверить логи |

Файл отчёта: **ОТЧЁТ_ЧТО_СДЕЛАНО_И_ОСТАЛОСЬ.md** (этот документ).
